name: smoke-prod

on:
  push:
    branches: [ release/landing-v1 ]
  pull_request:
    branches: [ release/landing-v1 ]
  workflow_dispatch: {}

jobs:
  smoke-prod:
    runs-on: ubuntu-latest
    steps:
      - name: Health must be 200
        run: |
          code=$(curl -sS -o /dev/null -w "%{http_code}" https://ecossistema5estrelas.org/api/health)
          echo "health: $code"
          test "$code" = "200"

      - name: Robots/Sitemap/RSS must be 200
        run: |
          for p in /robots.txt /sitemap.xml /rss.xml; do
            code=$(curl -sS -o /dev/null -w "%{http_code}" "https://ecossistema5estrelas.org$p")
            echo "$p -> $code"
            test "$code" = "200"
          done

      - name: Canonical presente e sem www
        run: |
          html=$(curl -sS https://ecossistema5estrelas.org)
          echo "$html" | grep -q 'rel="canonical"' || (echo "canonical ausente" && exit 1)
          echo "$html" | grep -q 'https://ecossistema5estrelas.org' || (echo "canonical com www ou domínio errado" && exit 1)
