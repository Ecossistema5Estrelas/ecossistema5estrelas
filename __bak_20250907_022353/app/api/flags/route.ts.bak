import { NextResponse } from "next/server";
import { initializeApp, cert, getApps } from "firebase-admin/app";
import { getFirestore } from "firebase-admin/firestore";
export const runtime = "nodejs";

if (!getApps().length) {
  const creds = process.env.FIREBASE_ADMIN_JSON!;
  if (!creds) throw new Error("FIREBASE_ADMIN_JSON not set");
  initializeApp({ credential: cert(JSON.parse(creds)) });
}
const db = getFirestore();

export async function GET(req: Request) {
  const url = new URL(req.url);
  const bucket = url.searchParams.get("bucket") ?? "control";
  const snap = await db.collection("feature_flags").get();

  const flags: Record<string, boolean> = {};
  snap.forEach(doc => {
    const d = doc.data() as any;
    flags[doc.id] = !!(d.on_global || (d.buckets?.[bucket] === true));
  });

  return NextResponse.json({ bucket, flags });
}
